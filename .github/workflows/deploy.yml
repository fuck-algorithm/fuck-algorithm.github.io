name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
    # å¿½ç•¥å¯¹æ–‡æ¡£å’Œé…ç½®æ–‡ä»¶çš„æ›´æ”¹
    paths-ignore:
      - '**.md'
      - '.github/**'
      - '!.github/workflows/**'
  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:

# è®¾ç½®æƒé™
permissions:
  contents: write
  pages: write
  id-token: write

# åŒæ—¶åªå…è®¸ä¸€ä¸ªéƒ¨ç½²å·¥ä½œæµè¿è¡Œ
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²ç”¨äºç‰ˆæœ¬ä¿¡æ¯
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js ğŸ“¦
        uses: actions/setup-node@v3
        with:
          node-version: '16'
          cache: 'npm'
          
      - name: Install Dependencies ğŸ”§
        run: npm install
        
      - name: Cache Webpack Build ğŸ“¦
        uses: actions/cache@v3
        with:
          path: |
            dist
            .cache
          key: ${{ runner.os }}-webpack-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('src/**/*') }}
          restore-keys: |
            ${{ runner.os }}-webpack-${{ hashFiles('**/package-lock.json') }}-
            ${{ runner.os }}-webpack-

      - name: Build ğŸ—ï¸
        run: npm run build
        env:
          NODE_ENV: production
          
      # æµ‹è¯•æ„å»ºç»“æœï¼ˆå¦‚æœæœ‰æµ‹è¯•å‘½ä»¤ï¼‰
      # - name: Test ğŸ§ª
      #   run: npm test
      
      # ç¡®ä¿distç›®å½•å­˜åœ¨
      - name: Check dist directory
        run: |
          ls -la dist || true
          mkdir -p dist
        
      - name: Deploy ğŸš€
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: dist # æ„å»ºè¾“å‡ºç›®å½•
          branch: gh-pages # è¦éƒ¨ç½²åˆ°çš„åˆ†æ”¯
          clean: true # è‡ªåŠ¨åˆ é™¤æ—§æ–‡ä»¶
          token: ${{ secrets.GITHUB_TOKEN }} # ä½¿ç”¨GitHubæä¾›çš„ä»¤ç‰Œ 